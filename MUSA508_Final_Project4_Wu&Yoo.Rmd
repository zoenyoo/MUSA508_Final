---
title: 'Modeling for New Jersey Transit Train Delay'
author: "Jasmine Siyu Wu & Zoe Yoo"
date: "10/19/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
  ioslides_presentation:
    self-included: yes
---


<br />


## 1. Introduction & Use Case

  For our project, we chose to estimate and model delays in the New Jersey Transit system. Our use case is to develop a tool for the NJ Transit app, specifically the Trip Planner tool, to let customers know which trains might be delayed.  
  New Jersey Transit and Amtrak both serve as commuter rail between Philadelphia, New Jersey, and New York. As Amtrak runs alongside, and is a competitor for, NJ Transit, we originally planned to also develop a website add-on for people buying their train tickets in advance. However, in the Kaggle dataset we use, the Amtrak data only includes actual departure times, not schedule times, which left us without any information on delay for Amtrak trains. 
  New Jersey Transit has a different ticketing system than Amtrak: tickets are only sold through the NJ Transit mobile app or in person, at stations. Additionally, its ticket prices do not fluctuate like Amtrak tickets, which vary based on date of reservation; there is no limit to the number of tickets sold, and one-way tickets have no expiry date. Due to these differences, predicting delay far in advance is not as important for our project, as people can buy tickets as-needed, even on the day of travel, without an influence in pricing. 
  So, we decided to conceptualize a tool for the New Jersey Transit App, and in particular, its Trip Planner feature. This tool is not geared towards ticket purchases, but for the convenience of customers who are planning when to take their trips. In the app's Trip Planner, users currently choose an origin and destination station, a date and time, and a factor to minimize (for example, travel time or walking distance). It then returns the schedule options available for that date and time.

  In this "Trip Options" screen, we aim to add an indicator for possible delay for each schedule option available, that refers to the total predicted time delay for each trip. Yellow indicates 10-19 minutes combined predicted delay, orange for 20-29 minutes, and red for over 30 minutes. There is no indicator for under 10 minutes, as we consider that "acceptable."
  In the Detailed Trip View, we would also add the same icons and categorization color scheme for each leg of a trip.


```{r setup, include=TRUE,   message = FALSE, results=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width = 10, fig.height = 5)

#Loading Libraries
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(riem)
library(lubridate)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance)
library(osmdata)
library(knitr)
library(tidycensus)
library(scales)
library(stargazer)
library(ggplot2)
library(ggpubr)
library(xtable)
library(ggmap)
library(leaflet)
library(leaflet.providers)
library(expss)


options(scipen=999) 
options(tigris_class = "sf")
options(tigris_use_cache = TRUE)

# functions and data directory
root.dir = "https://github.com/zoenyoo/MUSA508_Final.git"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


#Loading Styling Options
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

#Loading Quantile Break Functions
qBr <- function(df, variable, rnd) {
 if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                 c(.01,.2,.4,.6,.8), na.rm=T))
 } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                 c(.01,.2,.4,.6,.8), na.rm=T), digits = 3))
 }
}


q5 <- function(variable) {as.factor(ntile(variable, 5))}

#Loading Hexadecimal Color Palette

palette5 <- c("#324376", "#586ba4", "#f5dd90", "#ee964b", "#f95738")
palette4 <- c("#324376", "#586ba4", "#ee964b", "#f95738")
palette2 <- c("#324376", "#f95738")

```


<br />

## 2. Data Wrangling



<br />

### 2.1. Import Rail Delay Data



```{r rail_delay_data,  message = FALSE, warning = FALSE, fig.align='center'}

# January for training and 2-3 weeks in February for testing
rail_2020_01 <- read.csv(unz('Data/2020_01.csv.zip','2020_01.csv'), header = T)
rail_2020_02 <- read.csv(unz('Data/2020_02.csv.zip','2020_02.csv'), header = T)


rail_all <- rbind(rail_2020_01, rail_2020_02) %>%
  mutate(schedule60 = floor_date(ymd_hms(scheduled_time), unit = "hour"),
         actual60 = floor_date(ymd_hms(actual_time), unit = "hour"),
         week = week(schedule60),
         dotw = wday(schedule60, label=TRUE),
         year = year(schedule60),
         month = month(schedule60)) %>%
  drop_na(delay_minutes)
  #filter(week %in% c(14:18)) 

remove(rail_2020_01)
remove(rail_2020_02)


rail_cancelled <- subset(rail_all, status == "cancelled")
rail <- subset(rail_all, status != "cancelled")

summary_statistics <- 
  cbind(" " = list( "mean", "median", "min", "max"),
        "Delay_minutes" = list( "mean" = round(mean(rail$delay_minutes), digits=3),
                                "median" = round(median(rail$delay_minutes), digits=3),
                                "min" = round(min(rail$delay_minutes), digits=3),
                                "max" = round(max(rail$delay_minutes), digits=3)),
        "Dalay_hours" = list("mean" = round(mean(rail$delay_minutes/60), digits=3),
                             "median" =  round(median(rail$delay_minutes/60), digits=3),
                             "min" =  round(min(rail$delay_minutes/60), digits=3),
                             "max" =  round(max(rail$delay_minutes/60), digits=3))) %>% 
  as_data_frame() 

summary_statistics %>% 
  kable(digits=2, caption="Summary statistics of delay time at all recorded station stops - Jan.-Feb. 2020") %>% 
  kable_styling()
```

We first needed to actually determine if delay is severe enough often enough to warrant developing a model. As you can see, most trains in our sample set are delayed under ten minutes, with frequency reaching very low levels for delay over 40 minutes, and even less for over an hour.


```{r rail_delay_histogram,  message = FALSE, warning = FALSE, fig.align='center', fig.width=15}
ggplot(rail)+
  geom_histogram(aes(delay_minutes), binwidth = 0.5, fill = palette2[2], alpha=0.8)+
  #xlim(0, 100) +
  labs(title="New Jersey Transit Rail Delay at All Stops",
       subtitle = "Jan.-Feb. 2020",
       x="Minutes", 
       y="Frequency",
       caption="Figure 2.1")+
  plotTheme()
```


```{r rail_delay_histogram_break,  message = FALSE, warning = FALSE, fig.align='center', fig.width=15}
ggarrange(ncol=3,
          ggplot(subset(rail, delay_minutes<=10))+
            geom_histogram(aes(delay_minutes), binwidth = 0.5, fill = palette2[2], alpha=0.8)+
            #xlim(0, 100) +
            labs(x="Minutes", 
                 y="Frequency",
                   title="Delay Time of Trains at New Jersey Transit Stations, Jan-Feb 2020",
                   subtitle="within 10 minutes",
                 caption="Figure 2.2")+
            plotTheme(),
            ggplot(subset(rail, delay_minutes<=60 & delay_minutes > 10))+
              geom_histogram(aes(delay_minutes), binwidth = 0.5, fill = palette2[2], alpha=0.8)+
              #xlim(0, 100) +
              labs(x="Minutes", 
                   y="Frequency",
                   title=" ",
                   subtitle="10 minutes - 1 hour",
                   caption=" ")+
              plotTheme(),
            ggplot(subset(rail, delay_minutes > 60))+
              geom_histogram(aes(delay_minutes), binwidth = 0.5, fill = palette2[2], alpha=0.8)+
              #xlim(0, 100) +
              labs(x="Minutes", 
                   y="Frequency",
                   title=" ",
                   subtitle="over 1 hour",
                   caption="")+
              plotTheme())

```



### 2.2. Import Weather Data

Through the RIEM package, we import weather data to integrate into the modeling. There are three types of weather data available: precipitation, wind speed, and temperature. As trains are not affected by temperature the same way other modes of transportation might be (i.e. walking or cycling), it is most likely the least influential of our weather data. Precipitation generally would not delay service outside of extreme storms, in which snow buildup or mudslides might make tracks unusable; wind speed is similar, but has the potential to contribute to factors like blown-over trees. 

```{r weather_data,  message = FALSE, warning = FALSE, fig.align='center', fig.width=8, fig.height=6}

#https://mesonet.agron.iastate.edu/request/download.phtml?network=CA_ASOS
# EWR station is at Newark International Airport
weather.Data <- 
  riem_measures(station = "EWR", date_start = "2020-01-01", date_end = "2020-03-01") 

weather.Panel <-  
  weather.Data %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>% 
    replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid, 1, 13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Percipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

remove(weather.Data)

grid.arrange(bottom="Figure 2.2 Weather Data, New Jersey, January - February, 2020",
  ggplot(weather.Panel, aes(interval60, Percipitation)) +
    geom_line(color = palette2[2]) + 
    labs(title="Precipitation", x="Hour", y="Precipitation (in.)") + 
    plotTheme(),
  ggplot(weather.Panel, aes(interval60, Wind_Speed)) + 
    geom_line(color = palette2[2]) + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed (mph)") + 
    plotTheme(),
  ggplot(weather.Panel, aes(interval60, Temperature)) + 
    geom_line(color = palette2[2]) + 
    labs(title="Temperature", x="Hour", y="Temperature (F)") + 
    plotTheme())
```



### 2.3. Import Station and Place Data


```{r station_data,  message = FALSE, warning = FALSE, results = FALSE, fig.align='center'}
station.sf <- st_read("https://opendata.arcgis.com/datasets/4809dada94c542e0beff00600ee930f6_0.geojson") %>%
  st_transform("EPSG:3424") %>% #NAD83 / New Jersey (ftUS) 
  rename(STATION_NAME = STATION_ID)

station_list <- read.csv('Data/StationName_ID.csv', header = T)
station.sf <- left_join(station.sf, station_list, by=c("STATION_NAME" = "STATION_NAME"))


# mainly New Jersey yet a few in New York State and Penn
counties <- rbind(get_acs(geography = "county", 
                        year = 2019,
                        state = 34, 
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE),
                get_acs(geography = "county", 
                        year = 2019,
                        state = 42, 
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE),
                get_acs(geography = "county", 
                        year = 2019,
                        state = 36,
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE)) %>% 
  st_transform(st_crs(station.sf)) 
 
intersect.counties <-  subset(counties, GEOID %in% 
                              (st_intersection(counties, station.sf) %>%
                                 dplyr::select(GEOID) %>%
                                 st_drop_geometry() %>%
                                 unique())$GEOID)

rm(counties)

states <- rbind(get_acs(geography = "state", 
                        year = 2019,
                        state = 34, 
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE),
                get_acs(geography = "state", 
                        year = 2019,
                        state = 42, 
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE),
                get_acs(geography = "state", 
                        year = 2019,
                        state = 36,
                        variables = (TotalPop = 'B01001_001E'),
                        survey = "acs5",
                        output = "wide",
                        geometry = TRUE)) %>% 
  st_transform(st_crs(station.sf)) 

```

#### Map of NJ Transit Stations

```{r station_plot,  message = FALSE, warning = FALSE, fig.width=8, fig.align='center'}
# ggplot() +
#   geom_sf(data=intersect.counties, color='grey', fill=NA) +
#   geom_sf(data=station.sf, color=palette2[1], alpha=0.8, size=1) +
#   labs(title="New Jersey Transit and Amtrak Stations",
#        caption = "Figure 2.1") +
#   mapTheme() 

station.sf %>% st_transform(crs = 4326) %>%
  st_coordinates() %>% leaflet() %>% 
  addTiles() %>% 
  addProviderTiles("Thunderforest.Landscape") %>% addProviderTiles("Stamen.TonerHybrid") %>% 
  addMarkers(icon = list(iconSize = c(0.5, 0.5)))
```




### 2.4. Create Space-Time Panel and Time Lags


```{r rail_panel,  message = FALSE, warning = FALSE}
rail.template <- rail %>%
  semi_join(st_drop_geometry(station.sf),
            by = c( "to_id" = "STATION_ID"))

length(unique(rail.template$schedule60)) * length(unique(rail.template$to_id))

study.panel <-
  expand.grid(schedule60 = unique(rail.template$schedule60),
              to_id = unique(rail.template$to_id))

nrow(study.panel)


rail.panel <-
  rail.template %>%
    mutate(Train_Counter = 1) %>%
    right_join(study.panel) %>%
      group_by(schedule60, to, to_id) %>%
      summarize(Train_Count = sum(Train_Counter, na.rm=T),
                mean_delay_minutes = mean(delay_minutes, na.rm=T)) %>%
      left_join(weather.Panel, by = c( "schedule60" = "interval60")) %>%
        left_join(station.sf, by = c( "to_id" = "STATION_ID")) %>%
          mutate(week = week(schedule60),
                 dotw = wday(schedule60, label = TRUE)) # %>% st_sf()


rail.panel <-
  rail.panel %>%
    arrange(STATION_NAME, schedule60) %>%
    group_by(STATION_NAME) %>%
    mutate(lag12Hours = dplyr::lag(mean_delay_minutes,12),
           lag1day = dplyr::lag(mean_delay_minutes,24),
           lag2day = dplyr::lag(mean_delay_minutes,48),
           lag3day = dplyr::lag(mean_delay_minutes,72),
           lag4day = dplyr::lag(mean_delay_minutes,96),
           lag5day = dplyr::lag(mean_delay_minutes,120),
           lag6day = dplyr::lag(mean_delay_minutes,144),
           lag7day = dplyr::lag(mean_delay_minutes,168)) %>%
   ungroup()

```




## 3. Exploratory Analysis


PPM – the percentage of trains arriving at their destination within 5 minutes of schedule

```{r ppm,  message = FALSE, warning = FALSE}

ppm_summary <- data_frame(var = c("all_pp5", "all_pp10", "all_pp20"), 
                          val = c(
                                 round(nrow(subset(rail, delay_minutes<5))/nrow(rail)*100, digits=2),
                                 round(nrow(subset(rail, delay_minutes<10))/nrow(rail)*100, digits=2),
                                 round(nrow(subset(rail, delay_minutes<20))/nrow(rail)*100, digits=2)))

ppm_summary[,2] %>%  
  `rownames<-`(., c("Arrived within 5 minutes", "Arrived within 10 minutes",
                    "Arrived within 20 minutes")) %>% 
  kable(col.names = c("Percentage of trains")) %>% kable_styling()

```



```{r ppm plots,  message = FALSE, warning = FALSE, fig.width=15}
station.sf <- rail %>% group_by(to_id) %>%
    summarise(train_count = n(),
              mean_delay_minutes = mean(delay_minutes),
              ppm_5 = count_if(lt(5), delay_minutes)/train_count,
              ppm_10 = count_if(lt(10), delay_minutes)/train_count,
              ppm_20 = count_if(lt(20), delay_minutes)/train_count) %>% 
    right_join(station.sf, by = c( "to_id" = "STATION_ID")) %>%  
    st_sf() %>%
    st_transform(crs = 4326) 

ggarrange(ncol=3,
    ggplot() +
      geom_sf(data=intersect.counties, color='grey', fill=NA) +
      geom_sf(data=na.omit(station.sf), aes(color=ppm_5), size=2) +
        scale_color_gradient(high = "#FFFFFF", low = palette5[5],
                             name="PPM 5 minutes") + 
      labs(title="Punctuality Rate of Trains by Station",
           subtitle="Jan-Feb 2020",
           caption = "Figure 3.1") +
      mapTheme(),
    ggplot() +
      geom_sf(data=intersect.counties, color='grey', fill=NA) +
      geom_sf(data=na.omit(station.sf), aes(color=ppm_10), size=2) +
        scale_color_gradient(high = "#FFFFFF", low = palette5[5],
                             name="PPM 10 minutes") + 
      labs(title=" ",
           subtitle=" ",
           caption = " ") +
      mapTheme(),
    ggplot() +
      geom_sf(data=intersect.counties, color='grey', fill=NA) +
      geom_sf(data=na.omit(station.sf), aes(color=ppm_20), size=2) +
        scale_color_gradient(high = "#FFFFFF", low = palette5[5],
                             name="PPM 20 minutes") + 
      labs(title=" ",
           subtitle=" ",
           caption = " ") +
      mapTheme())

```



```{r rail trip timeseries,  message = FALSE, warning = FALSE, fig.width=12, fig.height=8}
grid.arrange(
  ggplot(rail %>%
           group_by(schedule60) %>%
           tally())+
    geom_line(aes(x = schedule60, y = n), color = palette2[1])+
    labs(title="Total train stops per hour of NJ Transit stations",
         subtitle="Jan. - Feb., 2020",
         x="Date", 
         y="Total train stops",
         caption=" ")+
    plotTheme(),
  ggplot(rail %>%
           group_by(schedule60) %>%
           summarise(mean_delay_minutes = mean(delay_minutes)))+
           #tally())+
    geom_line(aes(x = schedule60, y = mean_delay_minutes), color = palette2[2])+
    labs(title="Average delay time per hour of NJ Transit stations",
         subtitle="Jan. - Feb., 2020",
         x="Date", 
         y="Average delay minutes",
         caption="Figure 3.2")+
    plotTheme())
```




```{r day of week, message = FALSE, warning = FALSE, fig.height=8, fig.width=10}
grid.arrange(
  ggplot(rail)+
       geom_freqpoly(aes(hour(schedule60), color = dotw), binwidth = 1)+
       xlim(0, 24)+
       labs(title="Total rail stops of New Jersey Transit",
            subtitle = "New Jersey, Jan. - Feb., 2020",
            x="Hour", 
            y="Rail Stop Counts", caption = " ")+
       plotTheme(),
  ggplot(rail %>% mutate(hour=hour(schedule60)) %>%
         group_by(hour, dotw) %>%
         summarise(mean_delay_minutes = mean(delay_minutes)))+
       geom_line(aes(x=hour, y=mean_delay_minutes, color = dotw), binwidth = 1)+
       xlim(0, 24)+
       labs(title="Average delay time per hour of New Jersey Transit",
            subtitle = "New Jersey, Jan. - Feb., 2020",
            x="Hour", 
            y="Average Delay Minutes", caption = "Figure 3.3")+
       plotTheme())
```


```{r correlation_lag, cache = TRUE, message = FALSE, warning = FALSE, fig.height=4, fig.width=12}
plotData.lag <-
  as.data.frame(rail.panel) %>% drop_na(mean_delay_minutes) %>%
  group_by(schedule60) %>%
  summarise_at(c("lag12Hours","lag1day",
               "lag2day", "lag3day", 
               "lag4day", "lag5day", 
               "lag6day", "lag7day", "mean_delay_minutes"), mean, na.rm = TRUE) %>%
   dplyr::select(starts_with("lag"), mean_delay_minutes) %>%
  gather(Variable, Value, -mean_delay_minutes) %>%
  mutate(Variable = factor(Variable, levels=c("lag12Hours","lag1day",
                                              "lag2day", "lag3day", 
                                              "lag4day", "lag5day", 
                                              "lag6day", "lag7day")))
         
correlation.lag <- plotData.lag %>% 
  drop_na(Value) %>%
  group_by(Variable) %>%
  summarize(correlation = round(cor(Value, mean_delay_minutes, use = "complete.obs"), 2)) 



ggplot(data=plotData.lag, aes(Value, mean_delay_minutes)) +
  geom_point(size = .1) +
  geom_smooth(method = 'lm', se = F, color = palette2[2]) +
  geom_text(data = correlation.lag, color=palette2[2],
            aes(label = paste('r =', correlation)),
            x = -Inf, y = Inf, vjust = 1.5, 
            hjust = -.1, size = 5) +
  facet_wrap(~Variable, ncol=8) +
  labs(title = 'Rail delay minutes as a function of time lags', 
       x = 'Lag mean delay minutes',
       y = 'Mean delay minutes',
       caption = "Figure 3.4") +
  plotTheme()

```

## 4. Modeling and Validation



### 4.1 Preparing Train and Test Sets

```{r serial_correlation, cache = TRUE, message = FALSE, warning = FALSE, fig.width=12, fig.height=4}
mondays <- 
  mutate(rail,
         monday = ifelse(dotw == "Mon" & hour(schedule60) == 0,
                         schedule60, 0)) %>%
  filter(monday != 0) 

rail <- rail %>% 
  left_join(as_data_frame(rail.panel) %>% 
           dplyr::select(to_id, schedule60,
                         LATITUDE, LONGITUDE, 
                         Temperature, Percipitation, Wind_Speed,
                         lag12Hours,lag1day,lag2day, lag3day, 
                         lag4day, lag5day, lag6day, lag7day, mean_delay_minutes),  
           by=c("to_id" = "to_id", "schedule60" = "schedule60")) %>%
  rename(to_lag12Hours = lag12Hours, to_lag1day = lag1day,
         to_lag2day = lag2day, to_lag3day = lag3day,
         to_lag4day = lag4day, to_lag5day = lag5day,
         to_lag6day = lag6day, to_lag7day = lag7day,
         to_mean_delay_minutes = mean_delay_minutes) %>%
  left_join(as_data_frame(rail.panel) %>%
            dplyr::select(lag12Hours,lag1day,lag2day, lag3day,
                         lag4day, lag5day, lag6day, lag7day,
                         mean_delay_minutes, to_id, schedule60),
           by=c("from_id" = "to_id", "schedule60" = "schedule60")) %>%
  rename(from_lag12Hours = lag12Hours, from_lag1day = lag1day,
         from_lag2day = lag2day, from_lag3day = lag3day,
         from_lag4day = lag4day, from_lag5day = lag5day,
         from_lag6day = lag6day, from_lag7day = lag7day,
         from_mean_delay_minutes = mean_delay_minutes)


rail.Train <- filter(rail, week < 6)
rail.Test <- filter(rail, week >= 6 & week < 9)


rbind(mutate(rail.Train, Legend = "Training"), 
      mutate(rail.Test, Legend = "Testing")) %>%
    group_by(Legend, schedule60) %>% 
      summarise(mean_delay_minutes = mean(delay_minutes)) %>%
      ungroup() %>% 
      ggplot(aes(schedule60, mean_delay_minutes, colour = Legend)) + geom_line() +
        scale_colour_manual(values = palette2) +
        geom_vline(data = mondays, aes(xintercept = monday)) +
        labs(title="Rail trips by week: Januray-February",
             x="Day", y="Mean Delay Minutes",
             caption = "4.1") +
        plotTheme() + 
        theme(panel.grid.major = element_blank())    
```

### 4.2 Run Models

```{r train_test, message = FALSE, warning = FALSE, results="asis"}
reg1 <- 
  lm(delay_minutes ~  hour(schedule60) + dotw + Temperature + Percipitation,  data=rail.Train)

```

```{r train_test_2, message = FALSE, warning = FALSE, results="asis"}

reg2 <- 
  lm(delay_minutes ~  from + to + line + dotw + Temperature + Percipitation,  data=rail.Train)


```

```{r train_test_3, message = FALSE, warning = FALSE, results="asis"}
reg3 <-
  lm(delay_minutes ~  from + to + line + hour(schedule60) + dotw + Temperature + Percipitation,  data=rail.Train)

```

```{r train_test_4, message = FALSE, warning = FALSE, results="asis"}

reg4 <-
  lm(delay_minutes ~  from + to + line + hour(schedule60) + dotw + Temperature + Percipitation + 
       to_lag12Hours + to_lag1day + to_lag7day + from_lag12Hours + from_lag1day + from_lag7day,  data=rail.Train)


# stargazer(reg1, reg2, reg3, reg4, digits=3,
#           type="html", title="Table 4.1 Regression results",
#           single.row=TRUE,
#           column.labels=c("A. Time", "B. Space",
#                           "C. Time Space",
#                           "D. Time Space Timelag",
#                           "E. Time Space Timelag Transit"))


# summary(reg1) %>% 
#   xtable() %>%
#   kable(align='c', caption="Regression Model 1", 
#         digits=2) %>%
#   kable_styling() %>%
#   scroll_box(width = "100%", height = "300px")
```



<br />



### 4.3. Predict for Test Data


```{r predict_for_test, warning = FALSE, message = FALSE}
# nest data
rail.Test.weekNest <- 
  subset(rail.Test, 
         !from %in% c("Lake Hopatcong", "Lindenwold", "Middletown NY", 
                      "North Elizabeth", "Princeton Junction", 
                      "South Orange", "Secaucus Concourse") & 
           !to %in% c("Lake Hopatcong", 
                      "Lindenwold", "Middletown NY", 
                      "North Elizabeth", "Princeton Junction", 
                      "South Orange", "Secaucus Concourse")) %>% 
  group_by(week) %>%
  tidyr::nest()
  #nest(-week)

# predict function
model_pred <- function(dat, fit){
   pred <- predict(fit, newdata = dat)}


# do predictions
week_predictions <- 
  rail.Test.weekNest %>% 
    mutate(ATime_FE = map(.x = data, fit = reg1, .f = model_pred),
           BSpace_FE = map(.x = data, fit = reg2, .f = model_pred),
           CTime_Space_FE = map(.x = data, fit = reg3, .f = model_pred),
           DTime_Space_FE_timeLags = map(.x = data, fit = reg4, .f = model_pred)) %>% 
    gather(Regression, Prediction, -data, -week) %>%
    mutate(Observed = map(data, pull, delay_minutes),
           Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
           MAE = map_dbl(Absolute_Error, mean, na.rm = TRUE),
           sd_AE = map_dbl(Absolute_Error, sd, na.rm = TRUE))

```

<br />

### 4.4. Validate Test Set by Time


```{r plot_errors_by_model, warning = FALSE, message = FALSE, fid.width=12}
# week_predictions <- week_predictions %>%  
#     gather(Regression, Prediction, -data, -week) %>% 
#     mutate(Observed = map(data, pull, Trip_Count),
#            Absolute_Error = map2(Observed, Prediction,  ~ abs(.x - .y)),
#            MAE = map_dbl(Absolute_Error, mean),
#            sd_AE = map_dbl(Absolute_Error, sd))


week_predictions %>% 
  dplyr::select(Regression, MAE, week) %>%  
  gather(Variable, MAE, -Regression, -week) %>% 
  ggplot(aes(week, MAE)) + 
    geom_bar(aes(fill = Regression), position = "dodge", stat="identity") +
    scale_fill_manual(values = palette5) +
    labs(title = "Mean Absolute Errors by model specification and week",
         caption="Figure 4.2") +
  plotTheme()
```



```{r error_vs_actual_timeseries, warning = FALSE, message = FALSE, fig.width=9, fig.height=6}

week_predictions %>%  
  mutate(schedule60 = map(data, pull, schedule60),
         to = map(data, pull, to)) %>%
  dplyr::select(schedule60, to, Observed, Prediction, Regression) %>%
  unnest() %>%
  gather(Variable, Value, -Regression, -schedule60, -to, -week) %>%
    group_by(Regression, Variable, schedule60) %>%
    summarize(Value = mean(Value)) %>%
    ggplot(aes(schedule60, Value, colour=Variable)) + geom_line(size = 1.1) + 
      facet_wrap(~Regression, ncol=1) +
      scale_colour_manual(values = palette2) +
      labs(title = "Mean Predicted/Observed train delay minutes by hourly interval", 
           x = "Hour", y= "Mean delay minutes",
           caption = "Figure 4.3") +
      plotTheme()
```
<br />


### 4.5. Validate Test Set by Space


```{r validation_space, cache=TRUE, warning = FALSE, message = FALSE}
ggplot()+
  geom_sf(data=intersect.counties, fill="transparent",color = "gray") +
  geom_sf(data = (week_predictions %>% 
                      mutate(schedule60 = map(data, pull, schedule60),
                             to = map(data, pull, to)) %>%
                      select(schedule60, to, Observed, Prediction, Regression, -week) %>%
                      unnest(cols = c(schedule60, to, Observed, Prediction)) %>%
                      filter(Regression %in% c("DTime_Space_FE_timeLags")) %>%
                      group_by(schedule60, Regression, to) %>%
                      summarize(MAE = mean(abs(Observed-Prediction), na.rm = TRUE))%>%
                      left_join(station.sf, by = c("to" = "STATION_NAME"))),
             aes(color = MAE, geometry=geometry))+
  scale_color_gradient(high = "#f95738", low = "#fabbaf", limits = c(0, 0.4)) +
  facet_wrap(~Regression, ncol=2) +
  labs(title="Mean Abs Error of Test Set", 
       subtitle="Model D", 
       caption = "Figure 4.4") +
  mapTheme()

```

<br />

### 4.6. Cross-Validaton



## 5. Conclusion


There are definitely roads in which to both improve our model and expand upon the work we have already done. 

As Amtrak runs in the same areas as NJ Transit, it would be useful to compare the delays between the two systems. To accomplish this, the next step would be to insert actual schedule times into the Kaggle data, enabling us to calculate delays and develop a prediction model. 



